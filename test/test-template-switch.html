<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Switch Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .listbox { height: 200px; border: 2px solid #000; position: relative; padding: 10px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        button { padding: 8px 16px; margin: 5px; }
        .visible { background: yellow; }
        .invisible { background: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Template Switch Test</h1>
        
        <div>
            <button onclick="testToggle()">Toggle Print Mode</button>
            <button onclick="checkVisibility()">Check Visibility</button>
            <button onclick="manualRender()">Manual Render</button>
        </div>
        
        <div class="debug" id="debug"></div>
        
        <div class="listbox" id="listbox">
            <div>Initial content - if you see this, listbox isn't rendering</div>
        </div>
    </div>

    <!-- Templates with very distinct visual differences -->
    <template id="template-normal">
        <div style="background: #e3f2fd; border: 2px solid blue; padding: 10px; margin: 5px;">
            üìã NORMAL MODE: {{name}} ({{id}})
        </div>
    </template>

    <template id="template-print">
        <div style="background: #fff3e0; border: 2px solid orange; padding: 5px; margin: 2px;">
            üñ®Ô∏è PRINT MODE: {{name}}
        </div>
    </template>

    <script src="datamaster.js"></script>
    <script src="jw-listbox.js"></script>
    <script>
        const testData = [
            { id: 1, name: 'Alice' },
            { id: 2, name: 'Bob' }
        ];

        let lb;
        let printModeOn = false;

        function debug(msg) {
            const d = document.getElementById('debug');
            d.innerHTML += '[' + new Date().toLocaleTimeString() + '] ' + msg + '<br>';
            console.log(msg);
        }

        function init() {
            try {
                debug('üöÄ Starting initialization...');
                
                lb = new JwListBox('#listbox');
                debug('‚úÖ JwListBox created');
                
                lb.setSource(testData);
                debug('‚úÖ Data set');
                
                lb.setTemplate('#template-normal');
                debug('‚úÖ Normal template set to: #template-normal');
                
                lb.setPrintTemplate('#template-print');
                debug('‚úÖ Print template set to: #template-print');
                
                lb.setDisplayMode('list');
                debug('‚úÖ Display mode set to list');
                
                debug('üéØ Initialization complete!');
                
                // Verify initial render
                setTimeout(() => {
                    const content = document.querySelector('#listbox').innerHTML;
                    debug('üìÑ Initial render content length: ' + content.length);
                    debug('üìÑ Content preview: ' + content.substring(0, 100) + '...');
                    checkVisibility();
                }, 100);
                
            } catch (error) {
                debug('‚ùå Init error: ' + error.message);
                console.error(error);
            }
        }

        function testToggle() {
            try {
                printModeOn = !printModeOn;
                debug('üîÑ Toggling print mode to: ' + printModeOn);
                
                // Log state before
                debug('üìã Before - printMode: ' + lb._options.printMode);
                debug('üìã Before - template: ' + lb._options.template);
                debug('üìã Before - printTemplate: ' + lb._options.printTemplate);
                
                // Call printMode
                lb.printMode(printModeOn);
                
                // Log state after
                debug('üìã After - printMode: ' + lb._options.printMode);
                debug('üìã After - template: ' + lb._options.template);
                debug('üìã After - printTemplate: ' + lb._options.printTemplate);
                
                // Check what template is actually being used
                setTimeout(() => {
                    try {
                        const actualTemplate = lb._getTemplate();
                        debug('üéØ Retrieved template: ' + (actualTemplate ? actualTemplate.substring(0, 50) + '...' : 'NULL'));
                        
                        const content = document.querySelector('#listbox').innerHTML;
                        debug('üìÑ Content after toggle length: ' + content.length);
                        debug('üìÑ Content preview: ' + content.substring(0, 150) + '...');
                        
                        checkVisibility();
                    } catch (e) {
                        debug('‚ùå Post-toggle check error: ' + e.message);
                    }
                }, 50);
                
            } catch (error) {
                debug('‚ùå Toggle error: ' + error.message);
                console.error(error);
            }
        }

        function checkVisibility() {
            const listbox = document.querySelector('#listbox');
            const rows = listbox.querySelectorAll('.jw-listbox__row');
            
            debug('üëÄ Visibility check:');
            debug('   - Listbox element exists: ' + !!listbox);
            debug('   - Number of rows found: ' + rows.length);
            debug('   - Listbox innerHTML length: ' + listbox.innerHTML.length);
            
            if (rows.length > 0) {
                debug('   - First row visible: ' + (rows[0].offsetHeight > 0));
                debug('   - First row content: ' + rows[0].innerHTML.substring(0, 50) + '...');
                listbox.className += ' visible';
            } else {
                debug('   - ‚ùå NO ROWS FOUND!');
                listbox.className += ' invisible';
            }
        }

        function manualRender() {
            try {
                debug('üîß Manual render triggered');
                lb.render();
                setTimeout(checkVisibility, 50);
            } catch (error) {
                debug('‚ùå Manual render error: ' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JwListBox Sprint 2 Test (Mock DataMaster)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #container {
            width: 600px;
            height: 400px;
            border: 2px solid #333;
            margin: 20px 0;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
        }
        .debug {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>JwListBox Sprint 2 Test (Mock DataMaster)</h1>
    <p>Testing with a mock DataMaster implementation</p>
    
    <div class="controls">
        <button onclick="testRecordset()">Load Recordset Data</button>
        <button onclick="testTable()">Load Table Data</button>
        <button onclick="showInfo()">Show Component Info</button>
        <button onclick="clearDebug()">Clear Debug</button>
    </div>
    
    <div id="debug-output" class="debug"></div>
    
    <div id="container"></div>
    
    <script>
        // Mock DataMaster implementation for testing
        class DataMaster {
            constructor(data, fields) {
                this._data = data || [];
                this._fields = fields || [];
            }
            
            static fromRecordset(recordset, options = {}) {
                if (!Array.isArray(recordset) || recordset.length === 0) {
                    return new DataMaster([], []);
                }
                
                const fields = Object.keys(recordset[0]);
                return new DataMaster(recordset, fields);
            }
            
            static fromTable(table, options = {}) {
                if (!Array.isArray(table) || table.length === 0) {
                    return new DataMaster([], []);
                }
                
                let fields = [];
                let data = [];
                
                if (options.headersInFirstRow) {
                    fields = table[0];
                    data = table.slice(1).map(row => {
                        const obj = {};
                        fields.forEach((field, index) => {
                            obj[field] = row[index];
                        });
                        return obj;
                    });
                } else {
                    fields = table[0].map((_, index) => `field${index}`);
                    data = table.map(row => {
                        const obj = {};
                        fields.forEach((field, index) => {
                            obj[field] = row[index];
                        });
                        return obj;
                    });
                }
                
                return new DataMaster(data, fields);
            }
            
            static fromCsv(csvString, options = {}) {
                const lines = csvString.split('\n').filter(line => line.trim());
                if (lines.length === 0) {
                    return new DataMaster([], []);
                }
                
                const table = lines.map(line => {
                    return line.split(',').map(cell => cell.trim());
                });
                
                return DataMaster.fromTable(table, options);
            }
            
            toRecordset() {
                return this._data.slice(); // Return a copy
            }
            
            clone() {
                return new DataMaster(this._data.slice(), this._fields.slice());
            }
        }
        
        // Make DataMaster global for JwListBox
        window.DataMaster = DataMaster;
        
        function log(message) {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(message);
        }
        
        function clearDebug() {
            document.getElementById('debug-output').textContent = '';
        }
    </script>
    
    <!-- Load JwListBox -->
    <script src="jw-listbox.js"></script>
    
    <script>
        let listbox;
        
        function initializeListbox() {
            try {
                log('Initializing JwListBox...');
                listbox = new JwListBox('#container');
                
                // Set up error handling
                listbox.on('error', (error) => {
                    log('JwListBox Error: ' + JSON.stringify(error));
                });
                
                log('JwListBox initialized successfully');
                return true;
            } catch (error) {
                log('ERROR initializing JwListBox: ' + error.message);
                log('Stack: ' + error.stack);
                return false;
            }
        }

        // Test data sets
        const recordsetData = [
            { id: 1, name: 'Alice Johnson', age: 28, department: 'Engineering' },
            { id: 2, name: 'Bob Smith', age: 34, department: 'Marketing' },
            { id: 3, name: 'Carol Davis', age: 29, department: 'Design' }
        ];

        const tableData = [
            ['ID', 'Name', 'Age', 'Department'],
            [1, 'Alice Johnson', 28, 'Engineering'],
            [2, 'Bob Smith', 34, 'Marketing'],
            [3, 'Carol Davis', 29, 'Design']
        ];

        function testRecordset() {
            log('=== Testing Recordset Data ===');
            
            if (!listbox && !initializeListbox()) {
                return;
            }
            
            try {
                log('Setting recordset data: ' + JSON.stringify(recordsetData));
                listbox.setSource(recordsetData);
                log('Recordset data set successfully');
                
                setTimeout(() => {
                    showInfo();
                    checkDOMStructure();
                }, 100);
                
            } catch (error) {
                log('ERROR setting recordset: ' + error.message);
            }
        }

        function testTable() {
            log('=== Testing Table Data ===');
            
            if (!listbox && !initializeListbox()) {
                return;
            }
            
            try {
                log('Setting table data with headers: ' + JSON.stringify(tableData));
                listbox.setSource(tableData, { headersInFirstRow: true });
                log('Table data set successfully');
                
                setTimeout(() => {
                    showInfo();
                    checkDOMStructure();
                }, 100);
                
            } catch (error) {
                log('ERROR setting table: ' + error.message);
            }
        }

        function showInfo() {
            log('=== Component State ===');
            
            if (!listbox) {
                log('No listbox instance');
                return;
            }
            
            try {
                const dmRecords = listbox.dm ? listbox.dm.toRecordset().length : 0;
                const viewRecords = listbox.viewDm ? listbox.viewDm.toRecordset().length : 0;
                const mapSize = listbox._rowMap ? listbox._rowMap.size : 0;
                
                log('Master Data Records: ' + dmRecords);
                log('View Data Records: ' + viewRecords);
                log('Row Map Size: ' + mapSize);
                log('Display Mode: ' + listbox._options.displayMode);
                log('Internal ID Counter: ' + listbox._internalIdCounter);
                log('Is Dirty: ' + listbox._isDirty);
                
                if (listbox.dm && dmRecords > 0) {
                    log('Sample record: ' + JSON.stringify(listbox.dm.toRecordset()[0]));
                }
                
            } catch (error) {
                log('ERROR getting component info: ' + error.message);
            }
        }
        
        function checkDOMStructure() {
            log('=== DOM Structure ===');
            
            const container = document.getElementById('container');
            log('Container children: ' + container.children.length);
            
            const wrapper = container.querySelector('.jw-listbox-wrapper');
            if (wrapper) {
                log('Wrapper found');
                const body = wrapper.querySelector('.jw-listbox__body');
                if (body) {
                    log('Body found, innerHTML length: ' + body.innerHTML.length);
                    log('Body content: ' + body.innerHTML);
                    
                    const list = body.querySelector('.jw-listbox__list');
                    if (list) {
                        log('List found, children: ' + list.children.length);
                        for (let i = 0; i < list.children.length; i++) {
                            const item = list.children[i];
                            log(`Item ${i}: ${item.className}, data-internal-id: ${item.getAttribute('data-internal-id')}`);
                            log(`Item ${i} content: ${item.innerHTML}`);
                        }
                    } else {
                        log('No list element found');
                    }
                } else {
                    log('No body element found');
                }
            } else {
                log('No wrapper element found');
            }
        }

        // Initialize on load
        log('Page loaded, DataMaster mock ready');
        log('JwListBox available: ' + (typeof JwListBox !== 'undefined'));
        
        // Auto-initialize for testing
        setTimeout(() => {
            if (initializeListbox()) {
                testRecordset();
            }
        }, 100);
    </script>
</body>
</html>
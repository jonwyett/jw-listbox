<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JwListBox Sprint 4 Debug - Selection, Events, and Accessibility</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            width: 600px;
            height: 300px;
            border: 2px solid #333;
            margin: 20px 0;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
        }
        .debug {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        .section h3 {
            margin-top: 0;
        }
        .event-log {
            background: #e8f4f8;
            border: 1px solid #b0d4e3;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .selection-display {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
        .keyboard-help {
            background: #e7f3ff;
            border: 1px solid #b0c4de;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>JwListBox Sprint 4 Debug</h1>
    <p>Testing Selection, Events, and Accessibility (A11y) Features</p>
    
    <div class="section">
        <h3>Selection Mode Explanation</h3>
        <p><strong>Replace Mode (default):</strong> Click replaces current selection with the clicked item. Use Ctrl+Click to toggle individual items. Shift+Click for range selection.</p>
        <p><strong>Toggle Mode:</strong> Every click toggles the item's selection state (like Ctrl+Click in replace mode). Shift+Click still works for range selection.</p>
        <p><em>Both modes support multiple selections - the difference is just the interaction behavior!</em></p>
    </div>

    <!-- Selection Configuration -->
    <div class="section">
        <h3>Selection Mode Configuration</h3>
        <button onclick="setReplaceMode()">Replace Mode (click replaces selection)</button>
        <button onclick="setToggleMode()">Toggle Mode (click toggles selection)</button>
        <button onclick="toggleClickToSelect()">Toggle Click-to-Select</button>
        <button onclick="toggleAutoSelectFirst()">Toggle Auto-Select First</button>
    </div>

    <!-- Selection API Testing -->
    <div class="section">
        <h3>Selection API Testing</h3>
        <button onclick="selectFirst()">Select First Row</button>
        <button onclick="selectMultiple()">Select Multiple (IDs: 2, 4)</button>
        <button onclick="clearSelection()">Clear Selection</button>
        <button onclick="showCurrentSelection()">Show Current Selection</button>
    </div>

    <!-- Keyboard Navigation Help -->
    <div class="keyboard-help">
        <h3>Keyboard Navigation</h3>
        <p><strong>Instructions:</strong> Click in the listbox to focus it, then use:</p>
        <ul>
            <li><kbd>↑</kbd> / <kbd>↓</kbd> - Navigate up/down</li>
            <li><kbd>Home</kbd> / <kbd>End</kbd> - Go to first/last row</li>
            <li><kbd>Enter</kbd> / <kbd>Space</kbd> - Select current row</li>
            <li><strong>Replace Mode:</strong> <kbd>Ctrl+Click</kbd> / <kbd>Ctrl+Enter</kbd> - Toggle selection</li>
            <li><strong>Toggle Mode:</strong> Click or Enter automatically toggles</li>
            <li><kbd>Shift+Click</kbd> - Range selection (both modes)</li>
        </ul>
    </div>

    <!-- Current Selection Display -->
    <div class="selection-display">
        <strong>Current Selection:</strong>
        <div id="selection-display">None</div>
    </div>

    <div class="controls">
        <button onclick="clearEventLog()">Clear Event Log</button>
        <button onclick="clearDebug()">Clear Debug</button>
    </div>

    <div id="debug-output" class="debug"></div>
    
    <h3>Event Log</h3>
    <div id="event-log" class="event-log"></div>
    
    <div id="container1" class="container"></div>

    <!-- Test Template -->
    <template id="user-template">
        <div class="user-card" style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
            <h4 style="margin: 0 0 5px 0; color: inherit;">{{name}} (ID: {{id}})</h4>
            <p style="margin: 0; color: inherit; opacity: 0.8;">Email: {{email}}</p>
            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: inherit; opacity: 0.7;">Department: {{department}}</p>
        </div>
    </template>

    <!-- Load DataMaster and JwListBox -->
    <script src="datamaster.js"></script>
    <script src="jw-listbox.js"></script>

    <script>
        let listbox;
        
        function log(message) {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        function logEvent(eventName, payload) {
            const eventLog = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            
            // Simplify payload for readability
            let simplifiedPayload = payload;
            if (eventName === 'select') {
                simplifiedPayload = {
                    selectedIds: payload.selectedIds,
                    selectionCount: payload.selectionCount
                };
            } else if (payload && payload.id !== undefined) {
                simplifiedPayload = {
                    id: payload.id,
                    index: payload.index,
                    ...(payload.key && { key: payload.key })
                };
            }
            
            const eventInfo = `[${timestamp}] ${eventName}: ${JSON.stringify(simplifiedPayload)}\n`;
            eventLog.textContent += eventInfo;
            eventLog.scrollTop = eventLog.scrollHeight;
        }

        function updateSelectionDisplay() {
            const display = document.getElementById('selection-display');
            if (listbox) {
                const selected = listbox.getSelected();
                display.textContent = selected.length > 0 ? 
                    `IDs: [${selected.join(', ')}] (${selected.length} items)` : 
                    'None';
            } else {
                display.textContent = 'No listbox created';
            }
        }
        
        function clearDebug() {
            document.getElementById('debug-output').textContent = '';
        }

        function clearEventLog() {
            document.getElementById('event-log').textContent = '';
        }

        // Test data with numeric IDs
        const testData = [
            { 
                id: 1, 
                name: 'Alice Johnson', 
                email: 'alice@example.com',
                department: 'Engineering'
            },
            { 
                id: 2, 
                name: 'Bob Smith', 
                email: 'bob@example.com',
                department: 'Marketing'
            },
            { 
                id: 3, 
                name: 'Charlie Brown', 
                email: 'charlie@example.com',
                department: 'Sales'
            },
            { 
                id: 4, 
                name: 'Diana Prince', 
                email: 'diana@example.com',
                department: 'HR'
            },
            { 
                id: 5, 
                name: 'Ethan Hunt', 
                email: 'ethan@example.com',
                department: 'Operations'
            }
        ];

        function createListbox() {
            if (listbox) listbox.destroy();
            
            listbox = new JwListBox('#container1');
            
            // Set up all event listeners
            listbox.on('beforeRender', (payload) => logEvent('beforeRender', payload));
            listbox.on('render', (payload) => logEvent('render', payload));
            listbox.on('beforeDestroy', (payload) => logEvent('beforeDestroy', payload));
            listbox.on('destroy', (payload) => logEvent('destroy', payload));
            
            listbox.on('click', (payload) => logEvent('click', payload));
            listbox.on('dblclick', (payload) => logEvent('dblclick', payload));
            listbox.on('select', (payload) => {
                logEvent('select', payload);
                updateSelectionDisplay();
            });
            
            listbox.on('keydown', (payload) => logEvent('keydown', payload));
            
            listbox.on('error', (error) => {
                log('Error: ' + JSON.stringify(error));
                logEvent('error', error);
            });

            // Configure and set data
            listbox.setIdField('id')
                   .setTemplate('#user-template')
                   .setSource(testData);
            
            updateSelectionDisplay();
            return listbox;
        }

        function setReplaceMode() {
            log('=== Setting Replace Mode ===');
            
            if (!listbox) createListbox();
            
            listbox.setSelectionMode('replace');
            log('Replace mode: Click replaces selection. Use Ctrl+Click to toggle individual items.');
        }

        function setToggleMode() {
            log('=== Setting Toggle Mode ===');
            
            if (!listbox) createListbox();
            
            listbox.setSelectionMode('toggle');
            log('Toggle mode: Every click toggles selection (like Ctrl+click in replace mode).');
        }

        function toggleClickToSelect() {
            log('=== Toggling Click-to-Select ===');
            
            if (!listbox) createListbox();
            
            const currentState = listbox._options.clickToSelect;
            listbox.setClickToSelect(!currentState);
            log(`Click-to-select ${!currentState ? 'enabled' : 'disabled'}.`);
        }

        function toggleAutoSelectFirst() {
            log('=== Toggling Auto-Select First ===');
            
            if (!listbox) createListbox();
            
            const currentState = listbox._options.autoSelectFirst;
            listbox.setAutoSelectFirst(!currentState);
            log(`Auto-select first ${!currentState ? 'enabled' : 'disabled'}.`);
            
            // Recreate to test auto-selection
            if (!currentState) {
                log('Recreating listbox to test auto-selection...');
                createListbox();
            }
        }

        function selectFirst() {
            log('=== Selecting First Row ===');
            
            if (!listbox) createListbox();
            
            listbox.setSelected(1); // Select ID 1
            log('First row selected programmatically.');
        }

        function selectMultiple() {
            log('=== Selecting Multiple Rows ===');
            
            if (!listbox) createListbox();
            
            listbox.setSelected([2, 4]); // Select IDs 2 and 4
            log('Multiple rows selected programmatically (IDs: 2, 4). All modes support multi-selection via API.');
        }

        function clearSelection() {
            log('=== Clearing Selection ===');
            
            if (!listbox) {
                log('No listbox created yet.');
                return;
            }
            
            listbox.clearSelection();
            log('All selections cleared.');
        }

        function showCurrentSelection() {
            log('=== Current Selection ===');
            
            if (!listbox) {
                log('No listbox created yet.');
                return;
            }
            
            const selected = listbox.getSelected();
            log(`Currently selected IDs: [${selected.join(', ')}]`);
            log(`Selection count: ${selected.length}`);
        }

        // Auto-initialize
        setTimeout(() => {
            log('Auto-initializing listbox with selection features...');
            createListbox();
        }, 500);
    </script>
</body>
</html>